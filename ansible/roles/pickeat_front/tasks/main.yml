- name: Install nginx
  apt:
    update_cache: true
    cache_valid_time: 86400
    name:
      - nginx

- name: Make sure nginx service is enabled and running
  systemd:
    enabled: true
    state: started
    name: nginx.service

- name: Copy static files
  tags: app
  synchronize:
    src: to_deploy/frontend/
    dest: "/var/www/{{ pickeat_site_url }}/"
    rsync_opts:
    - "--chmod=F444"
  notify: Reload nginx service

- name: Update default nginx conf
  template:
    src: nginx.conf.j2
    dest: "/etc/nginx/nginx.conf"
    mode: '0644'
  notify: Reload nginx service

- name: Create site in nginx conf
  template:
    src: pickeat_nginx_site.j2
    dest: "/etc/nginx/sites-available/{{ pickeat_site_url }}"
    mode: '0444'
  notify: Reload nginx service

- name: Disable default site
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent
  notify: Reload nginx service

- name: Enable pick-eat site
  file:
    path: "/etc/nginx/sites-enabled/{{ pickeat_site_url }}"
    state: link
    src: "../sites-available/{{ pickeat_site_url }}"
  notify: Reload nginx service
